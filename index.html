<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteo Amigo Invisible üéÑ</title>
    <meta property="og:title" content="Amigo Invisible üéÅ">
    <meta property="og:description" content="Organiza o descubre tu amigo invisible aqu√≠.">
    <style>
        :root { --primary: #d42426; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; --green: #10b981; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; justify-content: center; min-height: 100vh; margin: 0; }
        
        .container { width: 100%; max-width: 500px; background: var(--card); padding: 30px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); height: fit-content; }
        
        h1 { text-align: center; color: var(--primary); margin-top: 0; font-size: 1.8rem; }
        p { line-height: 1.6; color: #4b5563; }
        
        /* Estilos Admin */
        textarea { width: 100%; height: 120px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; box-sizing: border-box; resize: vertical; margin-bottom: 15px; }
        textarea:focus { border-color: var(--primary); outline: none; }
        
        button.action-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; font-size: 1.1rem; font-weight: bold; border-radius: 8px; cursor: pointer; transition: transform 0.1s; }
        button.action-btn:active { transform: scale(0.98); }

        /* Lista de resultados */
        .result-list { list-style: none; padding: 0; margin-top: 25px; border-top: 1px solid #e5e7eb; }
        .result-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #e5e7eb; }
        .name-tag { font-weight: 600; }
        
        .btn-copy { background: #f3f4f6; border: none; padding: 8px; border-radius: 50%; cursor: pointer; color: #6b7280; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn-copy:hover { background: #e5e7eb; color: #111827; }
        .btn-copy.success { background: #d1fae5; color: var(--green); }
        .btn-copy svg { width: 24px; height: 24px; }

        /* Estilos Pantalla Revelaci√≥n */
        #view-reveal { text-align: center; }
        .gift-box { font-size: 4rem; margin: 20px 0; animation: bounce 2s infinite; }
        .reveal-name { font-size: 2rem; font-weight: 800; color: var(--primary); margin: 20px 0; padding: 20px; border: 2px dashed var(--primary); border-radius: 10px; background: #fff5f5; display: none; }
        
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-20px);} 60% {transform: translateY(-10px);} }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        <div id="view-admin" class="hidden">
            <h1>üéÖ Organizador</h1>
            <p>Ingresa los nombres de los participantes separados por comas. La herramienta generar√° un enlace √∫nico para cada uno.</p>
            
            <textarea id="input-names" placeholder="Ej: Juan, Ana, Pedro, Sof√≠a..."></textarea>
            
            <button class="action-btn" onclick="generarSorteo()">üé≤ Realizar Sorteo</button>
            
            <ul id="output-list" class="result-list"></ul>
            <p style="font-size: 0.8rem; color: #9ca3af; text-align: center; margin-top: 20px;">Los resultados se generan en tu navegador. Nada se guarda en ning√∫n servidor.</p>
        </div>

        <div id="view-reveal" class="hidden">
            <h1>Tu Amigo Invisible</h1>
            <div class="gift-box">üéÅ</div>
            <p>Te toc√≥ regalarle a...</p>
            
            <button id="btn-reveal" class="action-btn" onclick="mostrarNombre()">Ver Nombre</button>
            <div id="result-name" class="reveal-name"></div>
        </div>
    </div>

<script>
    // --- L√ìGICA DE ROUTING ---
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        
        if (params.has('q')) {
            // Si hay par√°metro 'q', mostramos la vista de PARTICIPANTE
            document.getElementById('view-reveal').classList.remove('hidden');
        } else {
            // Si no hay par√°metros, mostramos la vista de ADMIN
            document.getElementById('view-admin').classList.remove('hidden');
        }
    });

    // --- L√ìGICA DEL ADMIN ---
    function generarSorteo() {
        const input = document.getElementById('input-names').value;
        const listaUI = document.getElementById('output-list');
        listaUI.innerHTML = ''; // Limpiar

        let participantes = input.split(',').map(n => n.trim()).filter(n => n);

        if (participantes.length < 2) {
            alert("Necesitas al menos 2 personas para jugar.");
            return;
        }

        // Shuffle (Mezclar)
        participantes.sort(() => Math.random() - 0.5);

        // Detectar autom√°ticamente la URL base donde est√° alojado esto
        // Esto elimina el '?q=...' si existiera y deja la url limpia
        const urlBase = window.location.origin + window.location.pathname;

        participantes.forEach((quienRegala, i) => {
            let quienRecibe = (i === participantes.length - 1) ? participantes[0] : participantes[i+1];
            
            // Codificar
            // Usamos encodeURIComponent dentro de btoa para soportar tildes y emojis
            let hash = btoa(encodeURIComponent(quienRecibe));
            let link = `${urlBase}?q=${hash}`;
            let mensaje = `üéÑ Hola ${quienRegala}! Tu amigo invisible est√° aqu√≠: ${link}`;

            // Renderizar fila
            const li = document.createElement('li');
            li.className = 'result-item';
            li.innerHTML = `
                <span class="name-tag">${quienRegala}</span>
                <button class="btn-copy" onclick="copiar(this, '${escapeHtml(mensaje)}')" title="Copiar enlace para WhatsApp">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" />
                    </svg>
                </button>
            `;
            listaUI.appendChild(li);
        });
    }

    async function copiar(btn, texto) {
        try {
            await navigator.clipboard.writeText(texto);
            btn.classList.add('success');
            // Opcional: quitar la clase despu√©s de un rato
            // setTimeout(() => btn.classList.remove('success'), 2000);
        } catch (err) {
            prompt("Copia este texto manualmente:", texto);
        }
    }

    function escapeHtml(text) {
        return text.replace(/'/g, "\\'");
    }

    // --- L√ìGICA DEL PARTICIPANTE ---
    function mostrarNombre() {
        const params = new URLSearchParams(window.location.search);
        const encoded = params.get('q');
        
        if (!encoded) return;

        try {
            // Decodificar: Base64 -> URI Component -> String
            const nombre = decodeURIComponent(atob(encoded));
            
            const div = document.getElementById('result-name');
            div.innerText = nombre;
            div.style.display = 'block';
            
            // Ocultar bot√≥n y caja
            document.getElementById('btn-reveal').style.display = 'none';
            document.querySelector('.gift-box').innerText = 'üéÖ'; // Cambia √≠cono
        } catch (e) {
            alert("Error: El enlace parece estar roto o incompleto.");
        }
    }
</script>
</body>
</html>
