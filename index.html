<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteo Amigo Invisible üéÑ by SLZR Dev</title>
    <meta property="og:title" content="Amigo Invisible üéÅ">
    <meta property="og:description" content="Organiza o descubre tu amigo invisible aqu√≠.">
    <style>
        :root { --primary: #d42426; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; --green: #10b981; --warning-bg: #fff7ed; --warning-text: #9a3412; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; justify-content: center; min-height: 100vh; margin: 0; }
        
        .container { width: 100%; max-width: 500px; background: var(--card); padding: 30px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); height: fit-content; }
        
        h1 { text-align: center; color: var(--primary); margin-top: 0; font-size: 1.8rem; }
        h3 { font-size: 1rem; margin-bottom: 5px; color: #4b5563; }
        p { line-height: 1.6; color: #6b7280; font-size: 0.95rem; margin-top: 0; }
        
        /* Inputs */
        textarea { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; box-sizing: border-box; resize: vertical; margin-bottom: 15px; font-size: 0.9rem; }
        textarea:focus { border-color: var(--primary); outline: none; }
        
        #input-names { height: 80px; }
        #input-exclusions { height: 60px; border-color: #fca5a5; } 

        button.action-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; font-size: 1.1rem; font-weight: bold; border-radius: 8px; cursor: pointer; transition: transform 0.1s; }
        button.action-btn:active { transform: scale(0.98); }

        /* Lista de resultados */
        .result-list { list-style: none; padding: 0; margin-top: 25px; border-top: 1px solid #e5e7eb; }
        .result-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #e5e7eb; }
        .name-tag { font-weight: 600; }
        
        .btn-copy { background: #f3f4f6; border: none; padding: 8px; border-radius: 50%; cursor: pointer; color: #6b7280; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn-copy:hover { background: #e5e7eb; color: #111827; }
        .btn-copy.success { background: #d1fae5; color: var(--green); }
        .btn-copy svg { width: 24px; height: 24px; }
        
        /* Alertas e Instrucciones */
        #instructions { margin-top: 20px; padding-top: 20px; border-top: 1px dashed #e5e7eb; }
        .text-alert { color: #b91c1c; font-weight: 600; }
        
        .warning-box {
            background-color: var(--warning-bg);
            color: var(--warning-text);
            border: 1px solid #fdba74;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Estilos Pantalla Revelaci√≥n */
        #view-reveal { text-align: center; }
        .gift-box { font-size: 4rem; margin: 20px 0; animation: bounce 2s infinite; }
        .reveal-name { font-size: 2rem; font-weight: 800; color: var(--primary); margin: 20px 0; padding: 20px; border: 2px dashed var(--primary); border-radius: 10px; background: #fff5f5; display: none; }
        
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-20px);} 60% {transform: translateY(-10px);} }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        <div id="view-admin" class="hidden">
            <h1>üéÖ Organizador</h1>
            <p>Esta es una web para generar sorteos para jugar al amigo invisible.</p>
            <p>No guardamos ning√∫n dato, ni mails, ni nada.</p>
            <p>Aqu√≠ puedes organizar el sorteo y luego cada participante recibir√° un enlace para descubrir a qui√©n debe regalarle.</p>

            <h3>1. Participantes</h3>
            <p>Nombres separados por comas.</p>
            <textarea id="input-names" placeholder="Ej: Juan, Ana, Pedro, Sof√≠a..."></textarea>
            
            <h3>2. Exclusiones (Opcional)</h3>
            <p>Parejas que <b>NO</b> deben regalarse entre s√≠. Una pareja por l√≠nea, separada por coma.</p>
            <textarea id="input-exclusions" placeholder="Ej: Juan, Ana&#10;Pedro, Sof√≠a"></textarea>
            
            <button class="action-btn" onclick="generarSorteo()">üé≤ Realizar Sorteo</button>
            
            <ul id="output-list" class="result-list"></ul>
            
            <div id="instructions" class="hidden">
              <div class="warning-box">
                  <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                  <span><b>¬°IMPORTANTE!</b> No recargues esta p√°gina. Si lo haces, se perder√° el sorteo y tendr√°s que hacerlo de nuevo.</span>
              </div>

              <p>1. Copi√° el enlace que se genera para cada participante y env√≠aselo por el medio que quieras (WhatsApp, email, etc.).</p>
              <p>2. La persona al ingresar al enlace ver√° a qui√©n debe regalarle.</p>
              <p class="text-alert">¬°No veas los nombres de los dem√°s participantes para mantener la sorpresa!</p>
            </div>
        </div>

        <div id="view-reveal" class="hidden">
            <h1>Tu Amigo Invisible</h1>
            <div class="gift-box">üéÅ</div>
            <p>Te ha tocado regalarle a...</p>
            <button id="btn-reveal" class="action-btn" onclick="mostrarNombre()">Ver Nombre</button>
            <div id="result-name" class="reveal-name"></div>
        </div>
    </div>

<script>
    // --- L√ìGICA DE ROUTING ---
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        if (params.has('q')) {
            document.getElementById('view-reveal').classList.remove('hidden');
        } else {
            document.getElementById('view-admin').classList.remove('hidden');
        }
    });

    // --- L√ìGICA DEL ADMIN ---
    function generarSorteo() {
        const inputNames = document.getElementById('input-names').value;
        const inputExclusions = document.getElementById('input-exclusions').value;
        const listaUI = document.getElementById('output-list');
        const instructions = document.getElementById('instructions');
        listaUI.innerHTML = ''; 

        // 1. Parsear Nombres
        let participantes = inputNames.split(',').map(n => n.trim()).filter(n => n);
        if (participantes.length < 2) {
            alert("Necesitas al menos 2 personas.");
            return;
        }

        // 2. Parsear Exclusiones
        let exclusionesMap = {};
        let lineasExclusion = inputExclusions.split('\n');
        
        lineasExclusion.forEach(linea => {
            let partes = linea.split(',').map(n => n.trim()).filter(n => n);
            if (partes.length === 2) {
                agregarExclusion(exclusionesMap, partes[0], partes[1]);
                agregarExclusion(exclusionesMap, partes[1], partes[0]);
            }
        });

        // 3. Intentar generar un sorteo v√°lido
        let ordenValido = null;
        const MAX_INTENTOS = 1000;

        for (let i = 0; i < MAX_INTENTOS; i++) {
            participantes.sort(() => Math.random() - 0.5);
            let esValido = true;
            for (let j = 0; j < participantes.length; j++) {
                let quienRegala = participantes[j];
                let quienRecibe = (j === participantes.length - 1) ? participantes[0] : participantes[j+1];

                if (exclusionesMap[quienRegala] && exclusionesMap[quienRegala].includes(quienRecibe)) {
                    esValido = false;
                    break; 
                }
            }
            if (esValido) {
                ordenValido = participantes;
                break;
            }
        }

        if (!ordenValido) {
            alert("‚ö†Ô∏è No se pudo encontrar una combinaci√≥n v√°lida con esas restricciones.");
            return;
        }

        // 4. Renderizar Resultados
        const urlBase = window.location.origin + window.location.pathname;

        ordenValido.forEach((quienRegala, i) => {
            let quienRecibe = (i === ordenValido.length - 1) ? ordenValido[0] : ordenValido[i+1];
            let hash = btoa(encodeURIComponent(quienRecibe));
            let link = `${urlBase}?q=${hash}`;
            let mensaje = `üéÑ Hola ${quienRegala}! Tu amigo invisible est√° aqu√≠: ${link}`;

            const li = document.createElement('li');
            li.className = 'result-item';
            li.innerHTML = `
                <span class="name-tag">${quienRegala}</span>
                <button class="btn-copy" onclick="copiar(this, '${escapeHtml(mensaje)}')" title="Copiar enlace">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" />
                    </svg>
                </button>
            `;
            listaUI.appendChild(li);
        });
        
        instructions.classList.remove('hidden');

        // ACTIVAR PROTECCI√ìN CONTRA REFRESH
        // Esto hace que el navegador pregunte "¬øSeguro que quieres salir?"
        window.onbeforeunload = function() {
            return "Si recargas la p√°gina perder√°s los datos del sorteo.";
        };
    }

    // Helper para guardar exclusiones
    function agregarExclusion(map, nombreA, nombreB) {
        if (!map[nombreA]) map[nombreA] = [];
        map[nombreA].push(nombreB);
    }

    async function copiar(btn, texto) {
        try {
            await navigator.clipboard.writeText(texto);
            btn.classList.add('success');
        } catch (err) {
            prompt("Copia este texto manualmente:", texto);
        }
    }

    function escapeHtml(text) {
        return text.replace(/'/g, "\\'");
    }

    // --- L√ìGICA DEL PARTICIPANTE ---
    function mostrarNombre() {
        const params = new URLSearchParams(window.location.search);
        const encoded = params.get('q');
        if (!encoded) return;
        try {
            const nombre = decodeURIComponent(atob(encoded));
            const div = document.getElementById('result-name');
            div.innerText = nombre;
            div.style.display = 'block';
            document.getElementById('btn-reveal').style.display = 'none';
            document.querySelector('.gift-box').innerText = 'üéÖ';
        } catch (e) { alert("Error en el enlace."); }
    }
</script>
</body>
</html>
